<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>列表展示设置</title>
  <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
  <link rel="stylesheet" href="../../../renderer/settings.css" />
  <style>
    html, body { margin:0; padding:0 !important; }
    body { font-family: system-ui, Arial, sans-serif; background:#121212; color:#e6e6e6; }
    header { padding:12px 16px; border-bottom:1px solid #2c2c2c; display:flex; align-items:center; gap:10px; background:#171717; }
    header b { font-size:16px; }
    .muted { color:#9aa0a6; }
    main { padding:12px 16px 54px; }
    fieldset { border:1px solid #2c2c2c; border-radius:10px; padding:10px 12px; background:#1b1b1b; }
    legend { color:#9ab; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .ops { display:flex; gap:8px; margin-top:10px; }
    button { padding:6px 10px; border:1px solid #2c2c2c; background:#222; color:#e6e6e6; border-radius:8px; cursor:pointer; }
    button:hover { background:#2a2a2a; }
    select { background:#1f1f1f; color:#e6e6e6; border:1px solid #2a2a2a; border-radius:8px; padding:6px 10px; outline:none; }
    .bottomNav { position:fixed; left:0; right:0; bottom:8px; display:flex; justify-content:center; gap:24px; pointer-events:auto; }
    .bottomNav button { background:#222; border:1px solid #2c2c2c; border-radius:8px; padding:6px 12px; color:#e6e6e6; }
    .bottomNav i { font-size:22px; }
  </style>
</head>
<body>
  <header>
    <i class="ri-list-check-2"></i>
    <b>列表展示设置</b>
    <span id="serverTip" class="muted"></span>
  </header>
  <main>
    <fieldset>
      <legend>展示参数</legend>
      <div class="row">
        <label>默认排序<select id="sort"><option value="time">按时间（新→旧）</option><option value="alpha">按首字母（A→Z）</option></select></label>
        <label>显示提示<select id="hint"><option value="1">是</option><option value="0">否</option></select></label>
      </div>
      <div class="ops">
        <button id="start"><i class="ri-play-circle-line"></i> 开始列表展示</button>
        <button id="backHome"><i class="ri-arrow-go-back-line"></i> 返回首页</button>
      </div>
    </fieldset>
  </main>
  <div class="bottomNav">
    <button id="btnPrev" title="返回"><i class="ri-arrow-left-line"></i></button>
    <button id="btnNext" title="开始"><i class="ri-arrow-right-line"></i></button>
  </div>
  <script>
    const CH = 'multiword.lowbar';
    const qs = new URLSearchParams(location.search||'');
    const server = String(qs.get('server')||'').trim();
    const dayselParam = String(qs.get('daysel')||'').trim();
    const h = (id) => document.getElementById(id);
    const toUrl = (page, params={}) => { const base = new URL(page, window.location.href); Object.entries(params).forEach(([k,v]) => base.searchParams.set(k, String(v))); return base.href; };
    document.getElementById('serverTip').textContent = server ? ('已连接：' + server) : '(未传递服务器参数)';
    const state = { pool: [], selectedDays: new Set(dayselParam?dayselParam.split(',').map(s=>s.trim()).filter(Boolean):[]) };
    async function fetchPool(){ try { const u=new URL('/words', String(server||'').trim()); const r=await fetch(u.href); const j=await r.json(); state.pool = Array.isArray(j?.words) ? j.words : []; } catch (e) { state.pool = []; } }
    function buildSelectedSeq(){
      const selDays = Array.from(state.selectedDays||new Set());
      if (!selDays.length) {
        const cutoff = Date.now()-7*24*3600*1000;
        const list = state.pool.filter(x => (x.createdAt||0)>=cutoff);
        const seen=new Set(), seq=[];
        for(const it of list){ const w=String(it.word||'').toLowerCase(); if(!seen.has(w)){ seen.add(w); seq.push(w); } }
        return seq;
      }
      const list = state.pool.filter(x => selDays.includes(fmtDay(x.createdAt||Date.now())));
      list.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      const seen=new Set(), seq=[];
      for(const it of list){ const w=String(it.word||'').toLowerCase(); if(!seen.has(w)){ seen.add(w); seq.push(w); } }
      return seq;
    }
    function fmtDay(ms){ try{ const tz='Asia/Shanghai'; const d=new Date(ms||Date.now()); const parts=new Intl.DateTimeFormat('zh-CN',{timeZone:tz,hour12:false,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(d); const get=(t)=>parts.find(p=>p.type===t)?.value||''; return `${get('year')}-${get('month')}-${get('day')}`; } catch (e) { const d=new Date(ms||Date.now()); return [d.getFullYear(),String(d.getMonth()+1).padStart(2,'0'),String(d.getDate()).padStart(2,'0')].join('-'); } }
    h('start').onclick = async () => {
      try { if (!state.pool.length) await fetchPool(); } catch (e) {}
      const seq = buildSelectedSeq();
      const rangeStr = (() => {
        try {
          const sel = Array.from(state.selectedDays||new Set());
          if (sel.length) {
            const sorted = sel.slice().sort();
            return `${sorted[0]}~${sorted[sorted.length-1]}`;
          } else {
            const now = new Date();
            const fmt = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            const end = fmt(now);
            const startD = new Date(now.getFullYear(), now.getMonth(), now.getDate()-6);
            const start = fmt(startD);
            return `${start}~${end}`;
          }
        } catch (e) { return ''; }
      })();
      const bg = new URL('../background/allwords.html', window.location.href).href;
      const full = toUrl(bg, { server, sort: h('sort').value, hint: h('hint').value, selected: seq.join(','), range: rangeStr });
      window.lowbarAPI.emitEvent(CH, { type:'update', target:'backgroundUrl', value: full });
      window.lowbarAPI.emitEvent(CH, { type:'update', target:'centerItems', value: [
        { id:'allwords-sort-time', text:'按时间', icon:'ri-time-line' },
        { id:'allwords-sort-alpha', text:'按字母', icon:'ri-sort-alphabet-asc' },
        { id:'allwords-stop', text:'停止浏览', icon:'ri-stop-line' }
      ] });
      window.lowbarAPI.emitEvent(CH, { type:'update', target:'leftItems', value: [
        { id: 'go-home', text: '返回首页', icon: 'ri-home-3-line' },
        { id: 'export-open', text: '导出', icon: 'ri-download-2-line' }
      ] });
      window.lowbarAPI.emitEvent(CH, { type:'update', target:'floatingUrl', value: null });
    };
    h('backHome').onclick = () => { const home = new URL('./externallib.html', window.location.href).href; window.lowbarAPI.emitEvent(CH, { type:'update', target:'floatingUrl', value: home }); };
    h('btnPrev').onclick = () => {
      try {
        const float = new URL('./range-select.html', window.location.href).href;
        const href = toUrl(float, { server: String(server||'').trim(), next:'allwords', daysel: Array.from(state.selectedDays||new Set()).join(',') });
        window.lowbarAPI.emitEvent(CH, { type:'update', target:'floatingBounds', value: { width: 980, height: 680 } });
        window.lowbarAPI.emitEvent(CH, { type:'update', target:'floatingUrl', value: href });
      } catch (e) {}
    };
    h('btnNext').onclick = () => { h('start').click(); };
    (async function init(){ await fetchPool(); })();
  </script>
</body>
</html>
